#!/bin/sh
#
# Aether OS Init System v0.3
# Self-modifying AI operating system
#

# ============================================
# PHASE 1: Mount essential filesystems
# ============================================
mount -t proc none /proc
mount -t sysfs none /sys
mount -t devtmpfs none /dev 2>/dev/null || mknod -m 622 /dev/console c 5 1
mkdir -p /dev/pts /dev/shm
mount -t devpts devpts /dev/pts 2>/dev/null
mount -t tmpfs tmpfs /dev/shm 2>/dev/null

# Writable areas
mount -t tmpfs tmpfs /tmp
mount -t tmpfs tmpfs /run
mount -t tmpfs tmpfs /var
mkdir -p /var/log /var/tmp

# ============================================
# PHASE 2: Kernel configuration
# ============================================
hostname aether
[ -f /proc/sys/kernel/printk ] && echo "3 3 3 3" > /proc/sys/kernel/printk
[ -f /proc/sys/kernel/sysrq ] && echo 1 > /proc/sys/kernel/sysrq

# ============================================
# PHASE 3: Device initialization
# ============================================
[ -f /proc/sys/kernel/hotplug ] && echo /sbin/mdev > /proc/sys/kernel/hotplug
mdev -s 2>/dev/null

# ============================================
# PHASE 4: Networking
# ============================================
ip link set lo up 2>/dev/null
ip addr add 127.0.0.1/8 dev lo 2>/dev/null

if [ -d /sys/class/net/eth0 ]; then
    ip link set eth0 up 2>/dev/null
    udhcpc -i eth0 -s /etc/udhcpc.script -q -n -b 2>/dev/null &
fi

# Wait briefly for DHCP
sleep 2

# ============================================
# PHASE 5: Aether AI services (TCP mode)
# ============================================
# Service ports (TCP — kernel may lack AF_UNIX)
AETHERD_PORT=9101
AURORAD_PORT=9102
CFCD_HOST_ADDR=10.0.2.2:9100
BRAIN_HOST_ADDR=10.0.2.2:9200

start_aether_services() {
    # aetherd — audit/policy daemon (TCP on port 9101)
    if [ -x /sbin/aetherd ]; then
        AETHER_LOG_DIR=/var/log/aether AETHERD_TCP_PORT=$AETHERD_PORT /sbin/aetherd &
        echo "[init] aetherd started on tcp://0.0.0.0:$AETHERD_PORT"
    fi

    # aurorad — job routing daemon (TCP on port 9102, cfcd via host TCP, brain via host TCP)
    if [ -x /sbin/aurorad ]; then
        CFCD_HOST=$CFCD_HOST_ADDR BRAIN_HOST=$BRAIN_HOST_ADDR AURORAD_TCP_PORT=$AURORAD_PORT /sbin/aurorad &
        echo "[init] aurorad started on tcp://0.0.0.0:$AURORAD_PORT (cfcd: $CFCD_HOST_ADDR, brain: $BRAIN_HOST_ADDR)"
    fi

    # Brief pause for services to bind
    sleep 1
}

# Simple TCP port check (works without curl/netcat)
check_tcp_port() {
    # Try to connect to localhost:port using /dev/tcp if available,
    # otherwise check if the process is running
    if [ -e /proc/net/tcp ]; then
        # Convert port to hex and check /proc/net/tcp
        local hex_port=$(printf '%04X' "$1")
        grep -qi ":${hex_port} " /proc/net/tcp 2>/dev/null && return 0
    fi
    return 1
}

# ============================================
# PHASE 6: User environment
# ============================================
export HOME=/root
export PATH=/bin:/sbin:/usr/bin:/usr/sbin
export TERM=linux
export COLUMNS=80
export LINES=24
export PS1='\033[1;36maether\033[0m:\033[1;34m\w\033[0m\$ '

# Set terminal size for serial console
stty cols 80 rows 24 2>/dev/null

mkdir -p /root

# Helper scripts
cat > /bin/sysinfo << 'S'
#!/bin/sh
echo ""
echo "========== AETHER SYSTEM INFO =========="
echo "Kernel:     $(uname -r)"
echo "Arch:       $(uname -m)"
echo "Hostname:   $(hostname)"
echo "Uptime:     $(cut -d' ' -f1 /proc/uptime)s"
echo ""
echo "CPU:"
grep -m1 'model name' /proc/cpuinfo 2>/dev/null | cut -d: -f2 | xargs echo "  Model:    "
echo "  Cores:     $(grep -c processor /proc/cpuinfo)"
echo ""
echo "Memory:"
awk '/MemTotal/{t=$2}/MemFree/{f=$2}/MemAvailable/{a=$2}END{printf "  Total: %dMB\n  Free:  %dMB\n  Avail: %dMB\n",t/1024,f/1024,a/1024}' /proc/meminfo
echo ""
echo "Network:"
ip -brief addr 2>/dev/null | grep -v "^lo" || echo "  (no interfaces)"
echo ""
echo "Aether Services:"
aetherd_hex=$(printf '%04X' 9101)
aurorad_hex=$(printf '%04X' 9102)
if grep -qi ":${aetherd_hex} " /proc/net/tcp 2>/dev/null; then
    echo "  aetherd:  running (tcp://0.0.0.0:9101)"
else
    echo "  aetherd:  not running"
fi
if grep -qi ":${aurorad_hex} " /proc/net/tcp 2>/dev/null; then
    echo "  aurorad:  running (tcp://0.0.0.0:9102)"
else
    echo "  aurorad:  not running"
fi
echo "========================================"
S
chmod +x /bin/sysinfo

cat > /bin/help << 'H'
#!/bin/sh
echo ""
echo "========== AETHER OS v0.3 =========="
echo ""
echo "System:    sysinfo | ps | top | free | df | dmesg"
echo "Files:     ls | cat | cp | mv | rm | mkdir | vi"
echo "Network:   ip addr | ping | wget"
echo "AI:        nebula  (launch Nebula TUI shell)"
echo "Power:     poweroff | reboot"
echo "====================================="
H
chmod +x /bin/help

# ============================================
# PHASE 7: Boot banner + launch
# ============================================
echo "BOOT_SUCCESS"
clear 2>/dev/null || true

cat << 'BANNER'

    ___       __  __             ____  _____
   /   | ____/ /_/ /_  ___  ____/ __ \/ ___/
  / /| |/ _ \ __/ __ \/ _ \/ __/ / / /\__ \
 / ___ /  __/ /_/ / / /  __/ / / /_/ /___/ /
/_/  |_\___/\__/_/ /_/\___/_/  \____//____/

  v0.3.0 | Self-Modifying AI OS | Aeternum Labs

BANNER

echo "  Kernel: $(uname -r) | $(grep -c processor /proc/cpuinfo) cores | $(awk '/MemTotal/{printf "%dMB",$2/1024}' /proc/meminfo)"

# Start AI services
start_aether_services

# Check for AI connectivity
aurorad_hex=$(printf '%04X' $AURORAD_PORT)
if grep -qi ":${aurorad_hex} " /proc/net/tcp 2>/dev/null; then
    echo "  Aurora AI: connected (aurorad on port $AURORAD_PORT)"
else
    echo "  Aurora AI: offline (services may still be starting)"
fi

echo ""
echo "  Type 'help' for commands, 'sysinfo' for system status"
echo ""

# Launch GUI shell if framebuffer available and graphical boot, else TUI, else sh
cd /root
export AURORAD_TCP_PORT=$AURORAD_PORT

# Detect graphical mode: kernel cmdline has "console=tty0" when booting with display
GRAPHICAL_BOOT=false
if grep -q "console=tty0" /proc/cmdline 2>/dev/null; then
    GRAPHICAL_BOOT=true
fi

if $GRAPHICAL_BOOT && [ -e /dev/fb0 ] && [ -x /bin/nebula-fb ]; then
    exec /bin/nebula-fb
elif [ -x /bin/nebula ]; then
    exec /bin/nebula
else
    exec /bin/sh
fi

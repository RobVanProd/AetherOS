#!/bin/sh
#
# Aether OS Init System v0.2
# A usable interactive prototype
#

# ============================================
# PHASE 1: Mount essential filesystems
# ============================================
mount -t proc none /proc
mount -t sysfs none /sys
mount -t devtmpfs none /dev
mkdir -p /dev/pts /dev/shm
mount -t devpts devpts /dev/pts
mount -t tmpfs tmpfs /dev/shm

# Writable areas
mount -t tmpfs tmpfs /tmp
mount -t tmpfs tmpfs /run
mkdir -p /var/log /var/tmp
mount -t tmpfs tmpfs /var

# ============================================
# PHASE 2: Kernel configuration
# ============================================
# Set hostname
hostname aether

# Configure kernel printk (reduce noise)
echo "3 3 3 3" > /proc/sys/kernel/printk

# Enable magic sysrq for debugging
echo 1 > /proc/sys/kernel/sysrq

# ============================================
# PHASE 3: Device initialization
# ============================================
# Trigger udev-like coldplug (busybox mdev)
echo /sbin/mdev > /proc/sys/kernel/hotplug
mdev -s

# ============================================
# PHASE 4: Networking (if available)
# ============================================
setup_networking() {
    # Check if we have any network interfaces
    if [ -d /sys/class/net/eth0 ]; then
        echo "[net] Configuring eth0..."
        ip link set eth0 up
        
        # Try DHCP if udhcpc is available
        if command -v udhcpc > /dev/null; then
            udhcpc -i eth0 -s /etc/udhcpc.script -q -n &
        fi
    fi
    
    # Loopback
    ip link set lo up
    ip addr add 127.0.0.1/8 dev lo
}

# ============================================
# PHASE 5: System services
# ============================================
start_services() {
    # Syslog (if available)
    if command -v syslogd > /dev/null; then
        syslogd -O /var/log/messages
    fi
    
    # Create utmp/wtmp for login tracking
    touch /var/log/wtmp
    touch /run/utmp
}

# ============================================
# PHASE 6: User environment
# ============================================
setup_environment() {
    # Environment variables
    export HOME=/root
    export PATH=/bin:/sbin:/usr/bin:/usr/sbin
    export TERM=linux
    export PS1='\[\033[1;36m\]aether\[\033[0m\]:\[\033[1;34m\]\w\[\033[0m\]\$ '
    
    # Create home directory
    mkdir -p /root
    
    # Shell profile
    cat > /root/.profile << 'EOF'
export HOME=/root
export PATH=/bin:/sbin:/usr/bin:/usr/sbin
export TERM=linux
export PS1='\[\033[1;36m\]aether\[\033[0m\]:\[\033[1;34m\]\w\[\033[0m\]$ '

alias ll='ls -la'
alias cls='clear'
alias ..='cd ..'

echo ""
echo "Type 'help' for available commands"
echo "Type 'sysinfo' for system information"
echo ""
EOF
    
    # Create helpful scripts
    cat > /bin/sysinfo << 'EOF'
#!/bin/sh
echo ""
echo "========== AETHER SYSTEM INFO =========="
echo ""
echo "Kernel:     $(uname -r)"
echo "Arch:       $(uname -m)"
echo "Hostname:   $(hostname)"
echo "Uptime:     $(cut -d' ' -f1 /proc/uptime)s"
echo ""
echo "CPU:"
grep -m1 'model name' /proc/cpuinfo | cut -d: -f2 | xargs echo "  Model:    "
echo "  Cores:     $(grep -c processor /proc/cpuinfo)"
echo ""
echo "Memory:"
echo "  Total:     $(grep MemTotal /proc/meminfo | awk '{print $2 " " $3}')"
echo "  Free:      $(grep MemFree /proc/meminfo | awk '{print $2 " " $3}')"
echo "  Available: $(grep MemAvailable /proc/meminfo | awk '{print $2 " " $3}')"
echo ""
echo "Storage:"
df -h 2>/dev/null | grep -v tmpfs | head -5
echo ""
echo "Network:"
ip -brief addr 2>/dev/null || echo "  (no ip command)"
echo ""
echo "========================================"
EOF
    chmod +x /bin/sysinfo
    
    # Help command
    cat > /bin/help << 'EOF'
#!/bin/sh
echo ""
echo "========== AETHER OS COMMANDS =========="
echo ""
echo "System:"
echo "  sysinfo     - Display system information"
echo "  dmesg       - Kernel messages"
echo "  ps          - Running processes"
echo "  top         - Process monitor"
echo "  free        - Memory usage"
echo "  df          - Disk usage"
echo ""
echo "Files:"
echo "  ls, ll      - List files"
echo "  cat         - Display file contents"
echo "  cp, mv, rm  - Copy, move, delete"
echo "  mkdir       - Create directory"
echo "  vi          - Text editor"
echo ""
echo "Network:"
echo "  ip addr     - Network interfaces"
echo "  ping        - Test connectivity"
echo "  wget        - Download files"
echo ""
echo "Power:"
echo "  poweroff    - Shutdown system"
echo "  reboot      - Restart system"
echo ""
echo "========================================"
EOF
    chmod +x /bin/help
    
    # Aether-specific utilities
    cat > /bin/aether << 'EOF'
#!/bin/sh
case "$1" in
    version)
        echo "Aether OS v0.2.0-prototype"
        echo "Kernel: $(uname -r)"
        echo "Build: $(date)"
        ;;
    status)
        echo "Aether Status:"
        echo "  Boot time: $(cut -d' ' -f1 /proc/uptime)s"
        echo "  Processes: $(ps | wc -l)"
        echo "  Memory: $(grep MemAvailable /proc/meminfo | awk '{print $2}') kB free"
        ;;
    *)
        echo "Usage: aether <command>"
        echo ""
        echo "Commands:"
        echo "  version  - Show version info"
        echo "  status   - System status"
        ;;
esac
EOF
    chmod +x /bin/aether
}

# ============================================
# PHASE 7: Boot banner
# ============================================
show_banner() {
    clear
    cat << 'EOF'

    ___       __  __             ____  _____
   /   | ____/ /_/ /_  ___  ____/ __ \/ ___/
  / /| |/ _ \ __/ __ \/ _ \/ __/ / / /\__ \ 
 / ___ /  __/ /_/ / / /  __/ / / /_/ /___/ / 
/_/  |_\___/\__/_/ /_/\___/_/  \____//____/  
                                              
         v0.2.0-prototype | Aeternum Labs

EOF
    echo "=========================================="
    echo "  Boot successful"
    echo "  Kernel: $(uname -r) | Arch: $(uname -m)"
    echo "  Memory: $(grep MemTotal /proc/meminfo | awk '{print $2}') kB"
    echo "=========================================="
    echo ""
}

# ============================================
# MAIN BOOT SEQUENCE
# ============================================
main() {
    echo "[init] Aether OS starting..."
    
    setup_networking
    start_services
    setup_environment
    
    # Signal boot success (for Crucible detection)
    echo "BOOT_SUCCESS" > /dev/console
    
    show_banner
    
    # Source profile and drop to interactive shell
    cd /root
    . /root/.profile
    
    # Start interactive shell
    exec /bin/sh -l
}

main
